name: Apply SUSFS Patch (4.19)

on:
  workflow_dispatch:   # jalankan manual dari tab Actions

jobs:
  apply-patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # diperlukan untuk commit/push

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y patch git curl

      - name: Download SUSFS patch
        run: |
          curl -L \
          https://raw.githubusercontent.com/JackA1ltman/NonGKI_Kernel_Build_2nd/mainline/Patches/Patch/susfs_patch_to_4.19.patch \
          -o susfs_patch_to_4.19.patch

      - name: Apply patch
        run: |
          # Gunakan "patch" terlebih dahulu; jika gagal, coba git apply
          if patch -p1 --dry-run < susfs_patch_to_4.19.patch; then
            patch -p1 < susfs_patch_to_4.19.patch
          else
            echo "Fallback: git apply"
            git apply --whitespace=fix susfs_patch_to_4.19.patch
          fi

      # Hapus blok berikut jika Anda TIDAK ingin auto-commit
      - name: Commit & push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if ! git diff --quiet; then
            git add -A
            git commit -m "Apply SUSFS patch (4.19)"
            git push
          else
            echo "Tidak ada perubahan â€” patch sudah terpasang."
          fi
